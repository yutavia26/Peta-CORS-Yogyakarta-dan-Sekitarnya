<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Peta CORS Jogja • Leaflet + OSRM (Tugu CORS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --panel:#ffffffee;
      --muted:#6b7280;
      --accent:#06b6d4;
      --alt:#fb923c;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui, -apple-system, 'Segoe UI', Roboto, Arial;}
    #app{display:grid;grid-template-columns:380px 1fr;height:100vh;background:linear-gradient(135deg,#f8fafc 0%,#eef2ff 100%);}
    .sidebar{background:var(--panel);padding:16px;overflow:auto;border-right:1px solid #e5e7eb;box-shadow:0 8px 24px rgba(2,6,23,0.06);}
    #map{width:100%;height:100%;}
    .badge{display:inline-block;font-size:10px;font-weight:700;background:#e5e7eb;color:#111827;padding:4px 8px;border-radius:999px;}
    h1{font-size:18px;margin:10px 0 6px;}
    .sub{font-size:12px;color:var(--muted)}
    label{font-weight:600;font-size:12px;margin-top:12px;display:block}
    input[type="text"]{width:100%;border:1px solid #e5e7eb;background:#fafafa;padding:10px 12px;border-radius:10px;font-size:13px}
    .search-wrap{position:relative;margin-top:10px}
    #suggestBox{position:absolute;left:0;right:0;top:44px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;max-height:180px;overflow-y:auto;box-shadow:0 8px 24px rgba(2,6,23,0.08);display:none;z-index:999}
    .suggest-item{padding:8px 10px;cursor:pointer}
    .suggest-item:hover{background:#f3f4f6}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .mode-select{padding:8px;border-radius:8px;background:#f3f4f6;border:1px solid #e5e7eb;font-weight:700}
    .btn{padding:8px 12px;border-radius:10px;border:0;background:#111827;color:#fff;cursor:pointer;font-weight:700}
    .btn.light{background:#f3f4f6;color:#111827}
    .list{margin-top:12px;font-size:13px;color:#374151}
    .cors-item{padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;cursor:pointer}
    .cors-item:hover{background:#f8fafc}
    .cors-name{font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    .route-panel{position:absolute;right:20px;top:20px;width:320px;background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.12);z-index:9999}
    .route-panel h3{margin:0 0 8px;font-size:14px}
    .route-option{padding:8px;border-radius:8px;margin-bottom:8px;background:#fff;border:1px solid #eef2ff;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .route-option.active{border-color:var(--accent);box-shadow:0 4px 14px rgba(6,182,212,0.12)}
    .route-meta{font-size:12px;color:var(--muted)}
    .user-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .user-row img{width:34px;height:34px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.12)}
    @media (max-width:900px){#app{grid-template-columns:1fr}.route-panel{right:12px;left:12px;width:auto}}
  </style>
</head>
<body>
  <div id="app">
    <aside class="sidebar">
      <div><span class="badge">CORS Jogja</span><h1>Peta Sebaran CORS Jogja & Sekitarnya</h1>
        <div class="sub">Cari nama CORS, klik info, lalu tekan <b>Rute</b>. Panel rute menampilkan estimasi & pilihan rute.</div>
      </div>

      <label for="search">Cari nama CORS</label>
      <div class="search-wrap">
        <input id="search" type="text" placeholder="Ketik nama CORS..." oninput="onSearchInput()" />
        <div id="suggestBox"></div>
      </div>

      <div class="controls">
        <!-- note: onchange triggers recalculation jika panel terbuka -->
        <select id="mode" class="mode-select" title="Pilih moda routing" onchange="onModeChange()">
          <option value="driving">Mobil (driving)</option>
          <option value="motorcycle">Sepeda Motor (motorcycle)</option>
        </select>
        <button class="btn" id="routeBtn" onclick="routeToSelected()">Rute ke CORS</button>
        <button class="btn light" id="locateBtn" onclick="locateMe()">Lokasi Saya</button>
      </div>

      <div class="list" id="corsList"></div>
      <div style="margin-top:12px;font-size:12px;color:var(--muted)">Routing: OSRM public (router.project-osrm.org). Izin lokasi diperlukan.</div>
    </aside>

    <div id="map"></div>

    <!-- route panel (sidebar on map) -->
    <div class="route-panel" id="routePanel" style="display:none;">
      <h3>Estimasi & Pilihan Rute</h3>
      <div class="user-row"><img id="userIcon" src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="User"/> <div><div id="userCoords" class="small">Lokasi: -</div><div id="routeSummary" style="font-weight:700">Belum ada rute</div></div></div>
      <div id="routeOptions"></div>
      <div style="font-size:12px;margin-top:8px;color:var(--muted)">Klik opsi rute untuk menampilkan.</div>
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // ===== DATA CORS (contoh Jogja & sekitar) =====
  const corsStations = [
    { id: 'cors-ugm', name: 'CORS UGM', lat:-7.77032, lon:110.37739, info:'Universitas Gadjah Mada' },
    { id: 'cors-bpndiy', name: 'CORS BPN DIY', lat:-7.8016, lon:110.3647, info:'BPN DIY' },
    { id: 'cors-ppgl-sleman', name:'CORS PPGL Sleman', lat:-7.6890, lon:110.3440, info:'PPGL Sleman' },
    { id:'cors-bmkg-yia', name:'CORS BMKG YIA', lat:-7.9054, lon:110.0536, info:'BMKG Yogyakarta (YIA)' },
    { id:'cors-jogja-1', name:'CORS Kota Jogja 1', lat:-7.801, lon:110.364, info:'Titik contoh Kota Jogja' },
    { id:'cors-imogiri', name:'CORS Imogiri', lat:-7.833, lon:110.336, info:'Imogiri area' }
  ];

  // ===== map setup =====
  const map = L.map('map', { zoomControl:true }).setView([-7.7956,110.3695],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OSM contributors'}).addTo(map);

  const markersLayer = L.layerGroup().addTo(map);
  const routesLayer = L.layerGroup().addTo(map);

  // ===== icon: use your tugu.png in same folder =====
  // Save your uploaded PNG as "tugu.png" next to index.html
const tuguIcon = L.icon({
    iconUrl: 'image/cors.png',
    iconSize: [40, 80],
    iconAnchor: [20, 80],
    popupAnchor: [0, -75]
});

const tuguIconBlue = L.icon({
    iconUrl: 'image/cors.png',
    iconSize: [40, 80],
    iconAnchor: [20, 80],
    popupAnchor: [0, -75]
});


  // add markers + sidebar list
  const markerById = {};
  corsStations.forEach(c=>{
    const m = L.marker([c.lat,c.lon],{icon:tuguIcon}).addTo(markersLayer);
    m.bindPopup(`<b>${c.name}</b><br>${c.info}<br><small>${c.lat.toFixed(6)}, ${c.lon.toFixed(6)}</small><br><br><button onclick="window.routeToCoords(${c.lat},${c.lon})">Rute ke sini</button>`);
    markerById[c.id]=m;
  });

  // render list
  const corsListEl = document.getElementById('corsList');
  function renderList(){
    corsListEl.innerHTML='';
    corsStations.forEach(c=>{
      const row = document.createElement('div');
      row.className='cors-item';
      row.innerHTML = `
        <div>
          <div class="cors-name">${c.name}</div>
          <div class="small">${c.info}</div>
        </div>
        <div style="text-align:right">
          <div class="small">${c.lat.toFixed(4)}, ${c.lon.toFixed(4)}</div>
          <div style="margin-top:6px">
            <button class="btn" onclick="focusCORS('${c.id}')">Zoom</button>
            <button class="btn light" onclick="window.routeToCoords(${c.lat},${c.lon})">Rute</button>
          </div>
        </div>
      `;
      corsListEl.appendChild(row);
    });
  }
  renderList();

  // search autosuggest
  const searchInput = document.getElementById('search');
  const suggestBox = document.getElementById('suggestBox');
  function onSearchInput(){
    const q = searchInput.value.trim().toLowerCase();
    suggestBox.innerHTML='';
    if(!q){ suggestBox.style.display='none'; return; }
    const matches = corsStations.filter(c=>c.name.toLowerCase().includes(q));
    if(matches.length===0){ suggestBox.style.display='none'; return; }
    matches.forEach(m=>{
      const d = document.createElement('div');
      d.className='suggest-item';
      d.textContent = m.name;
      d.onclick = ()=>{ selectCORS(m); suggestBox.style.display='none'; };
      suggestBox.appendChild(d);
    });
    suggestBox.style.display='block';
  }
  function selectCORS(c){ searchInput.value=c.name; focusCORS(c.id); markerById[c.id].openPopup(); }

  function focusCORS(id){
    const c = corsStations.find(x=>x.id===id); if(!c) return;
    map.setView([c.lat,c.lon],16);
    const mk = markerById[id]; if(!mk) return;
    mk.setIcon(tuguIconBlue);
    setTimeout(()=>mk.setIcon(tuguIcon),1400);
    selected = c;
  }

  // ===== locate user =====
  let userMarker = null;
  async function locateMe(){
    if(!navigator.geolocation){ alert('Geolocation tidak tersedia'); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      if(userMarker) markersLayer.removeLayer(userMarker);
      userMarker = L.marker([lat,lon], { icon: L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/149/149071.png', iconSize:[34,34], iconAnchor:[17,17] })}).addTo(markersLayer).bindPopup('Lokasi Anda (GPS)').openPopup();
      map.setView([lat,lon],14);
      const userCoords = document.getElementById('userCoords');
      if(userCoords) userCoords.textContent = `Lokasi: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }, err=>{ alert('Gagal mendapatkan lokasi: '+(err.message||err)); }, { enableHighAccuracy:true, timeout:10000 });
  }
  window.locateMe = locateMe;

  // ===== ROUTING (OSRM via fetch) =====
  const OSRM = 'https://router.project-osrm.org';
  let lastOSRMResponse = null; // keep routes for selection
  let activeRouteLayer = null;
  let activeAltLayers = [];
  let lastDest = null;
  let lastModeRaw = null;

  // translateMode: maps UI mode to OSRM profile and returns a duration adjustment factor
function translateMode(raw){
  // returns { profile, durationFactor }
  if(raw === 'motorcycle'){
    // Faktor motor dibuat lebih realistis (10–15% lebih cepat)
    return { profile: 'driving', factor: 0.88 };
  }
  if(raw === 'driving') return { profile: 'driving', factor: 1.0 };
  if(raw === 'cycling') return { profile: 'cycling', factor: 1.0 };
  if(raw === 'foot') return { profile: 'foot', factor: 1.0 };
  return { profile: 'driving', factor: 1.0 };
}

  async function routeToSelected(){
    let target = null;
    const q = searchInput.value.trim().toLowerCase();
    if(q){
      target = corsStations.find(c=>c.name.toLowerCase()===q || c.name.toLowerCase().includes(q));
    }
    if(!target){
      target = corsStations[0];
    }
    await routeToCoords(target.lat, target.lon);
  }

  async function routeToCoords(destLat, destLon){
    // store last choices to allow onchange rerun
    lastDest = { lat: destLat, lon: destLon };
    lastModeRaw = document.getElementById('mode').value || 'driving';

    const { profile, factor } = translateMode(lastModeRaw);

    if(!navigator.geolocation){ alert('Browser tidak mendukung geolocation'); return; }

    navigator.geolocation.getCurrentPosition(async pos=>{
      const startLat = pos.coords.latitude, startLon = pos.coords.longitude;

      // set user marker and coords
      if(userMarker) markersLayer.removeLayer(userMarker);
      userMarker = L.marker([startLat,startLon], { icon: L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/149/149071.png', iconSize:[34,34], iconAnchor:[17,17] })}).addTo(markersLayer).bindPopup('Lokasi Anda (GPS)').openPopup();
      document.getElementById('userCoords').textContent = `Lokasi: ${startLat.toFixed(6)}, ${startLon.toFixed(6)}`;

      // clear previous routes
      if(activeRouteLayer){ routesLayer.removeLayer(activeRouteLayer); activeRouteLayer=null; }
      activeAltLayers.forEach(l=>routesLayer.removeLayer(l));
      activeAltLayers = [];
      lastOSRMResponse = null;
      document.getElementById('routeOptions').innerHTML = '';
      document.getElementById('routeSummary').textContent = 'Memuat...';
      document.getElementById('routePanel').style.display = 'block';

      // fetch OSRM using translated profile
      const url = `${OSRM}/route/v1/${profile}/${startLon},${startLat};${destLon},${destLat}?overview=full&geometries=geojson&alternatives=true`;
      try{
        const res = await fetch(url);
        const js = await res.json();
        if(!js.routes || js.routes.length===0){ document.getElementById('routeSummary').textContent='Rute tidak ditemukan'; return; }
        lastOSRMResponse = js;

        const routeOptionsEl = document.getElementById('routeOptions');
        routeOptionsEl.innerHTML = '';

js.routes.forEach((r, idx) => {
  const distKm = (r.distance / 1000).toFixed(2);
  const durMin = ((r.duration / 60) * factor).toFixed(1);

  const div = document.createElement('div');
  div.className = 'route-option' + (idx === 0 ? ' active' : '');
  div.onclick = () => showRoute(idx);

  div.innerHTML = `
    <div>
      <b>Rute ${idx + 1}</b>
      <div class="route-meta">${distKm} km • ${durMin} mnt</div>
    </div>
  `;

  routeOptionsEl.appendChild(div);
});

        // auto display main route (index 0)
        showRoute(0);

      }catch(err){
        console.error(err);
        document.getElementById('routeSummary').textContent = 'Gagal memuat rute';
      }

    }, err => {
      alert('Tidak dapat mengakses lokasi Anda. Pastikan izin lokasi diizinkan.');
    }, { enableHighAccuracy:true, timeout:10000 });
  }

  // show route by index from lastOSRMResponse
function showRoute(index){
  if(!lastOSRMResponse) return;

  if (activeRouteLayer) routesLayer.removeLayer(activeRouteLayer);
  activeAltLayers.forEach(l => routesLayer.removeLayer(l));
  activeAltLayers = [];

  const main = lastOSRMResponse.routes[index];
  const coords = main.geometry.coordinates.map(c => [c[1], c[0]]);

  // Rute utama (tebal)
  activeRouteLayer = L.polyline(coords, {
    color: '#06b6d4',
    weight: 7,
    opacity: 0.95
  }).addTo(routesLayer);

  // Rute alternatif
  lastOSRMResponse.routes.forEach((r, i) => {
    if(i === index) return;
    const altCoords = r.geometry.coordinates.map(c => [c[1], c[0]]);

    const altLine = L.polyline(altCoords, {
      color: '#fb923c',
      weight: 4,
      opacity: 0.6,
      dashArray: "6,6"
    }).addTo(routesLayer);

    activeAltLayers.push(altLine);
  });

  // Update panel
  const { factor } = translateMode(document.getElementById('mode').value);
  const distKm = (main.distance / 1000).toFixed(2);
  const durMin = ((main.duration / 60) * factor).toFixed(1);

  document.getElementById('routeSummary').textContent = `${distKm} km • ${durMin} mnt`;

  // Styling rute aktif
  document.querySelectorAll('.route-option').forEach((el, i) => {
    el.classList.toggle('active', i === index);
  });

  map.fitBounds(L.latLngBounds(coords).pad(0.1));
}


  // when user changes mode, recalc if we already have a destination
  function onModeChange(){
    if(lastDest){
      routeToCoords(lastDest.lat, lastDest.lon);
    }
  }

  // expose function for popup buttons
  window.routeToCoords = routeToCoords;
  window.routeToSelected = routeToSelected;
  window.showRoute = showRoute;
  window.focusCORS = function(id){ const c = corsStations.find(x=>x.id===id); if(!c) return; map.setView([c.lat,c.lon],16); markerById[id].openPopup(); };

  // close suggest box if click outside
  document.addEventListener('click', (ev)=>{
    const container = document.querySelector('.search-wrap');
    if(!container.contains(ev.target)) suggestBox.style.display='none';
  });

  // fit to show all
  const bounds = L.latLngBounds(corsStations.map(c=>[c.lat,c.lon]));
  if(bounds.isValid()) map.fitBounds(bounds.pad(0.2));
  </script>
</body>
</html>
